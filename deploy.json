{
    "contentVersion": "1.0.0.0",
    "parameters": {
      "workbookDisplayName": {
        "type": "string",
        "defaultValue": "Application Gateway WAF Triage",
        "metadata": {
          "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
        }
      },
      "LogAnalyticsWorkspaceName": {
        "type": "string",
        "metadata": {
          "description": "The name of the log analytics workspace to which the workbook will be associated.  Both need to be in the same resource group."
        }
      },
      "workbookId": {
        "type": "string",
        "defaultValue": "[newGuid()]",
        "metadata": {
          "description": "The unique guid for this workbook instance"
        }
      }
    },
    "variables": {
        "workbookSourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]",
        "workbookType": "workbook"
    },
    "resources": [
      {
        "name": "[parameters('workbookId')]",
        "type": "microsoft.insights/workbooks",
        "location": "[resourceGroup().location]",
        "apiVersion": "2018-06-17-preview",
        "dependsOn": [],
        "kind": "shared",
        "properties": {
          "displayName": "[parameters('workbookDisplayName')]",
          "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Application Gateway WAF triage workbook\\n---\\n\\nThis workbook will help you triage Application Gateway WAF violations.\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{subscription}\"],\"parameters\":[{\"id\":\"63ea93e5-3270-4447-9572-ad9e62095e7b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"subscription\",\"label\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"value\":[\"/subscriptions/651dc44c-5d8e-48da-8cd3-cd79224ac290\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":false}},{\"id\":\"12476248-81b7-46af-a9b4-790f93306442\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"workspace\",\"label\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| summarize by id, name\\r\\n| project id\",\"crossComponentResources\":[\"{subscription}\"],\"value\":\"/subscriptions/651dc44c-5d8e-48da-8cd3-cd79224ac290/resourceGroups/xstof-sap/providers/Microsoft.OperationalInsights/workspaces/xstof-sap-la\",\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"f451ddc5-00e3-4fe7-908e-22d0be9ab59c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"detectionTime\",\"label\":\"Detection Time\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureDiagnostics \\n| where Category == \\\"ApplicationGatewayFirewallLog\\\"\\n| where TimeGenerated {detectionTime}\\n| extend Id = new_guid()\\n| project-reorder Id, ResourceId, policyScopeName_s, action_s\\n//| summarize count() by ResourceId, policyScopeName_s, action_s\\n| evaluate pivot(action_s, count(), ResourceId, policyScopeName_s)\",\"size\":1,\"title\":\"Select the scope of the WAF policy\",\"exportedParameters\":[{\"fieldName\":\"policyScopeName_s\",\"parameterName\":\"PolicyScope\",\"parameterType\":1},{\"fieldName\":\"ResourceId\",\"parameterName\":\"ResourceId\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"ResourceId\",\"formatter\":5},{\"columnMatch\":\"Matched\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Blocked\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}}],\"rowLimit\":500,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"ResourceId\"]},\"labelSettings\":[{\"columnId\":\"ResourceId\",\"label\":\"App Gateway\"},{\"columnId\":\"policyScopeName_s\",\"label\":\"Policy Scope\"}]},\"tileSettings\":{\"showBorder\":false}},\"name\":\"query-app-gateway-resources\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ecbb87db-0dd5-4195-8ce4-7df364f4b64f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ShowMandatoryRules\",\"label\":\"Show Rules\",\"type\":10,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\" [{ \\\"value\\\": \\\"(\\\\\\\"true\\\\\\\", \\\\\\\"false\\\\\\\")\\\", \\\"label\\\": \\\"All Rules\\\" }, { \\\"value\\\": \\\"(false)\\\", \\\"label\\\": \\\"Only rules that can be disabled\\\", \\\"selected\\\": true }]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"(\\\"true\\\", \\\"false\\\")\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureDiagnostics \\r\\n| where Category == \\\"ApplicationGatewayFirewallLog\\\"\\r\\n| where TimeGenerated {detectionTime}\\r\\n| extend Id = new_guid()\\r\\n| where ResourceId == '{ResourceId}' and policyScopeName_s == '{PolicyScope}'\\r\\n| extend CanNotBeDisabled = Message startswith \\\"Mandatory rule.\\\"\\r\\n| where CanNotBeDisabled in {ShowMandatoryRules}\\r\\n| project-reorder Id, ResourceId, policyScopeName_s, action_s, ruleSetType_s, ruleSetVersion_s, ruleId_s, Message, hostname_s, requestUri_s, details_message_s, details_data_s, details_file_s, details_line_s, transactionId_g\\r\\n// | distinct ruleSetVersion_s, ruleSetType_s, ruleId_s, details_file_s, details_line_s, action_s\\r\\n| summarize Count = count() by ruleSetVersion_s, ruleSetType_s, ruleId_s, details_file_s, details_line_s, action_s\\r\\n| order by Count desc\\r\\n| project-reorder Count\\r\\n| extend Url = iif(isnotempty(ruleSetVersion_s),  strcat('https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/', 'v', ruleSetVersion_s, '/', details_file_s, '#L', details_line_s), '')\\r\\n//| summarize count() by ruleSetVersion_s, ruleSetType_s, ruleId_s\\r\\n//| distinct ruleSetVersion_s, ruleSetType_s, ruleId_s, Message, details_file_s, details_line_s, action_s, CanBeDisabled\",\"size\":0,\"showAnalytics\":true,\"title\":\"Rules that got triggered\",\"exportFieldName\":\"ruleId_s\",\"exportParameterName\":\"RuleId\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Url\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to SpiderLabs GitHub for this rule\"}}]}},\"customWidth\":\"100\",\"name\":\"query - violated rules\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//AzureDiagnostics \\r\\n//| where Category == \\\"ApplicationGatewayFirewallLog\\\"\\r\\n//| where TimeGenerated {detectionTime}\\r\\n//| extend Id = new_guid()\\r\\n//| where ResourceId == '{ResourceId}' and policyScopeName_s == '{PolicyScope}' and ruleId_s == '{RuleId}'\\r\\n//| project-reorder Id, action_s, ruleSetType_s, ruleSetVersion_s, ruleId_s, Message, hostname_s, requestUri_s, details_message_s, details_data_s, details_file_s, details_line_s, transactionId_g\\r\\n//| distinct hostname_s, httpMethod_s, requestUri_s, originalRequestUriWithArgs_s\\r\\nlet diagIdsForCurrentScopeAndRuleId = AzureDiagnostics \\r\\n| where Category == \\\"ApplicationGatewayFirewallLog\\\"\\r\\n| where TimeGenerated {detectionTime}\\r\\n| extend Id = new_guid()\\r\\n| where ResourceId == '{ResourceId}' and policyScopeName_s == '{PolicyScope}' and ruleId_s == '{RuleId}'\\r\\n| project-reorder Id, action_s, ruleSetType_s, ruleSetVersion_s, ruleId_s, Message, hostname_s, requestUri_s, details_message_s, details_data_s, details_file_s, details_line_s, transactionId_g\\r\\n| distinct transactionId_g;\\r\\nAzureDiagnostics\\r\\n| where Category == \\\"ApplicationGatewayAccessLog\\\"\\r\\n| where transactionId_g in (diagIdsForCurrentScopeAndRuleId)\\r\\n| distinct host_s, httpMethod_s, requestUri_s, originalRequestUriWithArgs_s\",\"size\":0,\"showAnalytics\":true,\"title\":\"Hosts and urls impacted by selected rule\",\"exportedParameters\":[{\"fieldName\":\"host_s\",\"parameterName\":\"HostName\",\"parameterType\":1},{\"fieldName\":\"requestUri_s\",\"parameterName\":\"RequestUri\",\"parameterType\":1},{\"fieldName\":\"originalRequestUriWithArgs_s\",\"parameterName\":\"FullUri\",\"parameterType\":1},{\"fieldName\":\"httpMethod_s\",\"parameterName\":\"Method\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"host_s\",\"httpMethod_s\",\"requestUri_s\"],\"expandTopLevel\":true},\"labelSettings\":[{\"columnId\":\"host_s\",\"label\":\"host\"},{\"columnId\":\"httpMethod_s\",\"label\":\"method\"},{\"columnId\":\"requestUri_s\",\"label\":\"uri\"},{\"columnId\":\"originalRequestUriWithArgs_s\",\"label\":\"full uri with querystring\"}]}},\"customWidth\":\"70\",\"name\":\"query - violated rules\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let transIdsWithFirewallLog = AzureDiagnostics\\r\\n| where Category == \\\"ApplicationGatewayFirewallLog\\\"\\r\\n| distinct transactionId_g;\\r\\nAzureDiagnostics\\r\\n| where Category == \\\"ApplicationGatewayAccessLog\\\"\\r\\n| where host_s == '{HostName}' and httpMethod_s == '{Method}' and requestUri_s == '{RequestUri}' and originalRequestUriWithArgs_s == '{FullUri}'\\r\\n| distinct transactionId_g\\r\\n| where transactionId_g in (transIdsWithFirewallLog)\\r\\n//AzureDiagnostics \\r\\n//| where Category == \\\"ApplicationGatewayFirewallLog\\\"\\r\\n//| where TimeGenerated {detectionTime}\\r\\n//| extend Id = new_guid()\\r\\n//| where ResourceId == '{ResourceId}' and policyScopeName_s == '{PolicyScope}' and ruleId_s == '{RuleId}' and hostname_s == '{HostName}' and requestUri_s == '{RequestUri}'\\r\\n//| project-reorder Id, action_s, ruleSetType_s, ruleSetVersion_s, ruleId_s, Message, hostname_s, requestUri_s, details_message_s, details_data_s, details_file_s, details_line_s, transactionId_g\\r\\n//| distinct transactionId_g\",\"size\":0,\"title\":\"Requests on selected host and url\",\"exportFieldName\":\"transactionId_g\",\"exportParameterName\":\"TransactionId\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"ImpactedRequestsFromSelectedUri\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureDiagnostics \\r\\n| where Category == \\\"ApplicationGatewayFirewallLog\\\"\\r\\n//| where TimeGenerated {detectionTime}\\r\\n| extend Id = new_guid()\\r\\n| where transactionId_g == '{TransactionId}'\\r\\n| project-reorder Id, action_s, ruleSetType_s, ruleSetVersion_s, ruleId_s, Message, hostname_s, requestUri_s, details_message_s, details_data_s, details_file_s, details_line_s, transactionId_g\\r\\n| extend Url = strcat('https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/', 'v', ruleSetVersion_s, '/', details_file_s, '#L', details_line_s)\\r\\n| project action_s, ruleId_s, Message, details_message_s, details_data_s, Url, TimeGenerated\\r\\n\",\"size\":0,\"title\":\"Rules that got triggered for selected request\",\"exportFieldName\":\"transactionId_g\",\"exportParameterName\":\"TransactionId\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"action_s\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Matched\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Blocked\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"more\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ruleId_s\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"{RuleId}\",\"representation\":\"blueDark\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Url\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to SpiderLabs GitHub for this rule\"}},{\"columnMatch\":\"statusFromAction\",\"formatter\":5,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}],\"labelSettings\":[{\"columnId\":\"action_s\",\"label\":\"action\"},{\"columnId\":\"ruleId_s\",\"label\":\"rule id\"},{\"columnId\":\"Message\",\"label\":\"message\"},{\"columnId\":\"details_message_s\",\"label\":\"details\"},{\"columnId\":\"details_data_s\",\"label\":\"matched data\"},{\"columnId\":\"TimeGenerated\",\"label\":\"time generated\"}]}},\"name\":\"TriggeredRules\"},{\"type\":1,\"content\":{\"json\":\"Display filtered for AppGw: {ResourceId} and Policy Scope: {PolicyScope}\\r\\n\\r\\nShow mandatory rules: {ShowMandatoryRules}\\r\\n\\r\\nHost: {HostName}\\r\\n\\r\\nRequestUri: {RequestUri}\\r\\n\\r\\nTransactionId: {TransactionId}\"},\"name\":\"text - 3\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/651dc44c-5d8e-48da-8cd3-cd79224ac290/resourceGroups/xstof-sap/providers/Microsoft.OperationalInsights/workspaces/xstof-sap-la\"]}",
          "version": "1.0",
          "sourceId": "[variables('workbookSourceId')]",
          "category": "[variables('workbookType')]"
        }
      }
    ],
    "outputs": {
      "workbookId": {
        "type": "string",
        "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
      }
    },
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
  }